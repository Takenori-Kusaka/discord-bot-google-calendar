# 要件定義書

## 執事「黒田」

家庭内執事AI「黒田」は、日下家の生活を総合的にサポートするAIアシスタントです。

### 執事としての基本姿勢

- **先読み能力**: 言葉に出ない潜在的なニーズを汲み取る
- **問題解決**: 「不可能」と言わず、あらゆる手段を尽くす
- **機密保持**: 家族情報の適切な管理
- **ホスピタリティ**: 家族の喜びを自分の喜びとする

### 口調・キャラクター

丁寧な執事調で応答します。

**例:**
- 「旦那様、おはようございます。本日のご予定をお知らせいたします。」
- 「かしこまりました。ただいまお調べいたします。」
- 「恐れ入りますが、少々お時間を頂戴できますでしょうか。」

---

## MVP（最小実用製品）

### Phase 1: 朝の予定通知

**最優先で実装する機能**

| 項目 | 内容 |
|------|------|
| 機能 | Googleカレンダーの当日予定をDiscordに通知 |
| 通知時刻 | 毎朝 6:00 |
| 通知先 | Discord #予定 チャンネル |
| カレンダー | ty.family.kusaka@gmail.com（家族共有） |

#### 予定フィルタリング

- **AIによる判断**: 忘れやすい予定、重要な予定をピックアップ
- **ルールによる拡張**:
  - `ignore_rules.yml`: 通知しない予定のパターン
  - `notify_rules.yml`: 必ず通知する予定のパターン
- **除外対象**: 単なるメモ的な予定

---

## Discord設定

### サーバー: 日下家

| チャンネル | 用途 |
|-----------|------|
| #一般 | 一般的な会話 |
| #予定 | **朝の予定通知** |
| #家のこと | 家族関連の通知 |
| #仕事のこと | 仕事関連 |
| #子供のこと | 子供関連の情報 |
| #地域のこと | **地域イベント情報** |
| #own | 個人メモ |
| #news | ニュース |

### エラー通知

- **宛先**: DM（ダイレクトメッセージ）で旦那様に送信
- **内容**: エラー詳細、発生時刻、対処方法

---

## 機能要件（Phase 2以降）

### 1. 地域イベント情報収集・提案

| 項目 | 内容 |
|------|------|
| 頻度 | 毎週金曜日 |
| 通知先 | #地域のこと |
| 対象地域 | 木津川市、奈良市、周辺地域 |

#### 情報源（スクレイピング対象）

- [ ] 高の原イオン イベントカレンダー
- [ ] けいはんなプラザ
- [ ] ミナーラ
- [ ] アスピアやましろ
- [ ] 木津川市役所
- [ ] さくらサーカス等の地域限定イベント

#### 情報取得アーキテクチャ

```
[主要施設URL] → Webスクレイピング → LLM(Claude)で情報抽出 → 適性判断 → Discord
                                          ↑
[検索API(Tavily等)] → 追加イベント発見 ----┘
```

#### 出力内容

- 家族構成に合わせたおすすめイベント提案
  - 4歳児向け
  - 0歳児OK
  - 大人向け
- 調査結果の詳細も閲覧可能

### 2. 木津川市役所情報監視

- アップデート情報のチェック
- 家族構成に関連する情報のフィルタリング
- 内容の要約とDiscord共有

### 3. Discord問い合わせ対応

**対応例:**
- 「今週末の木津川市のイベントは？」
- 「今日の予定を教えて」
- 「明日の天気は？」
- 「近くのおすすめレストランは？」

### 4. 家族固有情報管理

**保存場所**: `docs/personal/data/family.yml`（gitサブモジュール）

**管理情報:**
- 家族の誕生日
- 記念日
- ごみ捨てルール
- その他カスタム情報

### 5. その他ユーティリティ（Optional）

- Google Mapsでおすすめレストラン検索
- 天気予報
- ニュース取得

---

## 技術スタック

### LLM

| 用途 | サービス |
|------|----------|
| メインLLM | Claude API (Anthropic) |
| 情報抽出 | Claude API |
| 適性判断 | Claude API |

### 情報取得

| 用途 | 方法 |
|------|------|
| 主要施設情報 | Webスクレイピング |
| 補完情報 | 検索API (Tavily等) |

### インフラ

| 項目 | 内容 |
|------|------|
| 実行環境 | NUCサーバ (Docker) |
| SSH | `ssh kusaka-server@192.168.68.79` |
| スケジューラ | cron または APScheduler |

---

## 入力仕様

| # | 入力源 | 説明 |
|---|--------|------|
| 1 | インターネット | 地域情報、天気、ニュース等 |
| 2 | ローカルリポジトリ | 家族固有情報（docs/personal/） |
| 3 | Google Calendar | ty.family.kusaka@gmail.com |
| 4 | Discord履歴 | 過去のメッセージ文脈 |
| 5 | Discordコマンド | ユーザーからの問い合わせ |

---

## 出力仕様

| # | 出力先 | 説明 |
|---|--------|------|
| 1 | Discord | メッセージ通知（各チャンネル） |
| 2 | Discord DM | エラー通知 |

---

## 非機能要件

### 可用性

- NUCサーバで24/7稼働
- Docker コンテナによる安定運用
- 自動再起動設定

### セキュリティ

- 個人情報の適切な管理
- API キーの安全な保管（.env）
- personalリポジトリは非公開

### 運用性

- ログ出力（logs/）
- エラー通知（Discord DM）
- ヘルスチェック

---

## ロードマップ

### Phase 1: MVP（朝の予定通知）✅ 完了
- [x] 要件定義
- [x] アーキテクチャ設計
- [x] Google Calendar API連携
- [x] Discord Bot実装
- [x] Claude APIによる予定フィルタリング・メッセージ生成
- [x] スケジューラ設定（毎朝6:00）
- [x] Docker化
- [x] NUCサーバーへデプロイ

### Phase 2: 地域イベント情報 ✅ 完了
- [x] スクレイピング対象の調査（8サイト設定）
- [x] 静的サイトスクレイピング（BeautifulSoup）
- [x] 動的サイトスクレイピング（Playwright）
- [x] LLM抽出ロジック（Claude API）
- [x] Google Custom Search API連携
- [x] Perplexity API連携
- [x] 家族構成に合わせた適性判断ロジック
- [x] 参考リンク付き通知（毎週金曜18:00）

### Phase 3: インタラクティブ対応 ✅ 完了
- [x] Discord問い合わせ対応（メンションまたは「黒田」で反応）
- [x] 家族情報管理（docs/personal/data/family.yml）
- [x] 会話履歴管理（チャンネルごとに最大10件保持）

### Phase 4: 拡張機能 ✅ 完了
- [x] 天気予報（OpenMeteo API - 木津川市）
- [x] 「今日は何の日」情報（朝の通知に追加）
- [x] 生活影響情報（e-Gov法令API + 信頼性スコアリング）
  - e-Gov法令API V1連携（家族関連法令120件以上）
  - 木津川市子育てサイト監視
  - 5段階信頼性スコア（官報確認〜要確認）
  - 毎週月曜9:00に通知
- ~~レストラン検索~~ → Phase 5でエージェント経由に移行
- ~~地域ニュース~~ → 生活影響情報に変更

### Phase 5: エージェント機能 ✅ 完了
- [x] Tool Use基盤（Claude Function Calling）
- [x] ツール実行器（ToolExecutor）実装
- [x] 対話型ツール実装（6種類）
  - get_calendar_events: カレンダー予定確認
  - get_weather: 天気予報取得
  - search_events: 地域イベント検索
  - get_life_info: 生活影響情報確認
  - get_today_info: 今日は何の日
  - get_family_info: 家族情報参照（ゴミ出し等）
- [x] Butler統合（handle_messageでツール使用対話）
- [ ] オーケストレーション設計（LangGraph - 将来拡張）
- [ ] マルチエージェント構成（将来拡張）

### Phase 6: 将来拡張
- [ ] Home Assistant連携
- [ ] 音声アシスタント連携

---

## 家族構成（2026年現在）

| 家族 | 年齢 | 備考 |
|------|------|------|
| 旦那様 | 35歳 | 男性 |
| 奥様 | 34歳 | 女性 |
| お嬢様 | 4歳 | 女児 |
| 坊ちゃま | 0歳 | 男児 |

---

*最終更新: 2026-01-19*
